# Устранение проблем с чатом

## LangSmith API Key отсутствует

**Вопрос:** Вижу сообщение "LangSmith API key is missing". Может ли это быть причиной того, что чат работает неверно?

**Ответ:** Нет, отсутствие LangSmith API key **НЕ влияет** на работу чата. LangSmith используется только для:
- Мониторинга выполнения workflow в LangGraph Studio
- Логирования и отладки
- Визуализации трассировки выполнения

Ваш чат будет работать нормально без LangSmith API key.

### Если хотите использовать LangSmith (опционально):

1. Зарегистрируйтесь на [LangSmith](https://smith.langchain.com)
2. Получите API key в настройках: https://smith.langchain.com/settings
3. Добавьте в `.env`:
   ```
   LANGSMITH_API_KEY=lsv2_pt_your-key-here
   ```

## Реальные проблемы, которые могут влиять на работу чата

### 1. Отсутствует OpenAI API Key

**Симптомы:**
- Чат не отвечает
- Ошибки в логах: "OpenAI API key not found"
- Пустые ответы

**Решение:**
```bash
# Проверьте, что .env файл существует
ls -la .env

# Убедитесь, что ключ установлен
grep OPENAI_API_KEY .env

# Если ключа нет, добавьте его
echo "OPENAI_API_KEY=sk-your-key-here" >> .env
```

### 2. Сервер LangGraph не запущен

**Симптомы:**
- Swift приложение не может подключиться к серверу
- Ошибки подключения в логах

**Решение:**
```bash
# Запустите сервер
cd langgraph_server
python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload

# Или используйте скрипт
./langgraph_server/run.sh
```

### 3. Отсутствуют файлы с эмбеддингами

**Симптомы:**
- RAG поиск не работает
- Пустые ответы или ошибки при поиске

**Решение:**
```bash
# Проверьте наличие файлов
ls -la data/live12-manual-chunks-with-embeddings.json
ls -la data/Ableton-versions-diff-chunks-with-embeddings.json

# Если файлов нет, сгенерируйте их
python scripts/process_manual.py
```

### 4. Проблемы с импортами в LangGraph Studio

**Симптомы:**
- Ошибка "ModuleNotFoundError" при запуске `langgraph dev`
- Workflow не загружается в Studio

**Решение:**
```bash
# Установите пакет в режиме разработки
pip install -e .

# Проверьте импорты
python -c "from langgraph_server.workflow import create_workflow; print('OK')"
```

### 5. Проблемы с сессиями

**Симптомы:**
- Состояние не сохраняется между запросами
- Workflow начинается заново каждый раз

**Решение:**
- Убедитесь, что используете один и тот же `session_id` для всех запросов в рамках одной сессии
- Проверьте, что сервер не перезапускается между запросами

## Диагностика проблем

### Проверка работы сервера

```bash
# Проверьте, что сервер запущен
curl http://localhost:8000/health

# Должен вернуть: {"status":"ok"}
```

### Проверка логов

```bash
# Смотрите логи сервера в реальном времени
# В терминале, где запущен сервер, должны быть DEBUG сообщения
```

### Тестирование endpoint

```bash
# Тестовый запрос к /chat
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Как создать новый проект?",
    "ableton_edition": "Ableton Live Suite",
    "history": []
  }'
```

## Частые ошибки

### "No response generated"

**Причина:** Workflow не дошел до генерации ответа или произошла ошибка

**Решение:**
- Проверьте логи сервера на наличие ошибок
- Убедитесь, что OpenAI API key правильный
- Проверьте, что файлы с эмбеддингами существуют

### "Session not found"

**Причина:** Используется несуществующий session_id

**Решение:**
- Создайте новую сессию (не передавайте session_id в первом запросе)
- Или используйте существующий session_id из предыдущего ответа

### Workflow застревает

**Причина:** Workflow ждет действия пользователя (action_required)

**Решение:**
- Проверьте поле `action_required` в ответе
- Отправьте следующий запрос с `user_choice` в поле `message`

## Получение помощи

Если проблема не решена:

1. Проверьте логи сервера на наличие ошибок
2. Убедитесь, что все зависимости установлены: `pip install -r requirements.txt`
3. Проверьте версии Python (требуется >= 3.10)
4. Убедитесь, что все файлы на месте (см. структуру проекта в README)

